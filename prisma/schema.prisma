generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model Game {
  id                      String                    @id @default(uuid())
  name                    String                    @unique
  image_url               String                    @db.Text
  description             String                    @db.Text
  players                 String
  playtime                String
  mechanics               String                    @db.Text
  categories              String                    @db.Text
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  baseGameId              String?
  isExpansion             Boolean                   @default(false)
  GameSessionGameJunction GameSessionGameJunction[]
  PlayerGameJunction      PlayerGameJunction[]
}

model Player {
  id                        String                      @id @default(uuid())
  name                      String
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime                    @updatedAt
  clerkId                   String?                     @unique
  nickname                  String?
  email                     String?                     @unique
  isSuperAdmin              Boolean                     @default(false)
  gameGroupsLeft            Int                         @default(1)
  PlayerGameSessionJunction PlayerGameSessionJunction[]
  PlayerGameJunction        PlayerGameJunction[]
  PlayerGameGroupJunction   PlayerGameGroupJunction[]
  PlayerAchievement         PlayerAchievement[]
}

model GameGroup {
  id                      String                    @id
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  name                    String                    @default("Game Night")
  hidden                  Boolean                   @default(false)
  PlayerGameGroupJunction PlayerGameGroupJunction[]
  EmailInvite             EmailInvite[]
}

model PlayerGameSessionJunction {
  id            String      @id @default(uuid())
  playerId      String
  gameSessionId String
  position      Int?
  score         String?
  player        Player      @relation(fields: [playerId], references: [id])
  gameSession   GameSession @relation(fields: [gameSessionId], references: [id])

  @@unique([playerId, gameSessionId])
}

model GameSessionGameJunction {
  id            String      @id @default(uuid())
  gameId        String
  gameSessionId String
  game          Game        @relation(fields: [gameId], references: [id])
  gameSession   GameSession @relation(fields: [gameSessionId], references: [id])

  @@unique([gameId, gameSessionId])
}

model GameSession {
  id                          String                        @id @default(uuid())
  gameId                      String
  result                      String?
  status                      String
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime                      @updatedAt
  groupId                     String                        @default("game-night")
  description                 String?
  isTeamGame                  Boolean                       @default(false)
  PlayerGameSessionJunction   PlayerGameSessionJunction[]
  GameSessionGameJunction     GameSessionGameJunction[]
  GameSessionRandomizationLog GameSessionRandomizationLog[]
  GameSessionTeam             GameSessionTeam[]
}

model GameSessionTeam {
  id                 String               @id @default(uuid())
  gameSessionId      String
  name               String
  color              String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @default(now()) @updatedAt
  gameSession        GameSession          @relation(fields: [gameSessionId], references: [id])
  TeamPlayerJunction TeamPlayerJunction[]

  @@index([gameSessionId])
}

model TeamPlayerJunction {
  id        String          @id @default(uuid())
  teamId    String
  playerId  String
  createdAt DateTime        @default(now())
  updatedAt DateTime        @default(now()) @updatedAt
  team      GameSessionTeam @relation(fields: [teamId], references: [id])

  @@unique([teamId, playerId])
  @@index([playerId])
  @@index([teamId])
}

model PlayerGameJunction {
  id        String   @id @default(uuid())
  gameId    String
  playerId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Game      Game     @relation(fields: [gameId], references: [id])
  Player    Player   @relation(fields: [playerId], references: [id])

  @@unique([gameId, playerId])
}

model PlayerGameGroupJunction {
  id                String    @id @default(uuid())
  groupId           String
  playerId          String
  role              String
  inviteStatus      String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  gameGroupIsActive Boolean   @default(false)
  GameGroup         GameGroup @relation(fields: [groupId], references: [id])
  Player            Player    @relation(fields: [playerId], references: [id])

  @@unique([groupId, playerId])
}

model GameSessionRandomizationLog {
  id            String      @id @default(uuid())
  gameSessionId String
  type          String      @db.VarChar(255)
  data          Json
  createdAt     DateTime    @default(now())
  GameSession   GameSession @relation(fields: [gameSessionId], references: [id])

  @@index([gameSessionId], map: "idx_log_gamesession")
}

model EmailInvite {
  id            String    @id @default(uuid())
  clerkInviteId String    @unique
  emailAddress  String
  groupId       String
  status        String    @default("pending")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  GameGroup     GameGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId], map: "groupId")
}

model Achievement {
  id                String              @id @default(uuid())
  key               String              @unique
  name              String
  description       String              @db.Text
  category          String
  tier              String
  goal              Int
  iconType          String              @default("sparkles")
  points            Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  PlayerAchievement PlayerAchievement[]
}

model PlayerAchievement {
  id            String       @id @default(uuid())
  playerId      String
  achievementId String
  progress      Int          @default(0)
  unlockedAt    DateTime?
  groupId       String
  metadata      Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  player        Player       @relation(fields: [playerId], references: [id])
  achievement   Achievement  @relation(fields: [achievementId], references: [id])

  @@unique([playerId, achievementId, groupId])
  @@index([playerId, groupId])
  @@index([achievementId])
}
